---
- name: Check if Git is installed
  ansible.windows.win_shell: git --version
  register: git_check
  failed_when: false
  changed_when: false

- name: Check if Git installer exists
  ansible.windows.win_stat:
    path: C:\Windows\Temp\GitSetup.exe
  register: installer_check

- name: Download Git installer if not present
  ansible.windows.win_powershell:
    script: |
      Invoke-WebRequest -Uri "https://git-scm.com/downloads/win" -OutFile "C:\Windows\Temp\git_page.html"
      $page = Get-Content "C:\Windows\Temp\git_page.html" -Raw
      $link = ($page | Select-String 'href="(.*?)">Git for Windows/x64 Setup').Matches.Groups[1].Value
      Invoke-WebRequest -Uri $link -OutFile "C:\Windows\Temp\GitSetup.exe"
      Remove-Item "C:\Windows\Temp\git_page.html"
  when: git_check.rc != 0 and not installer_check.stat.exists
  
- name: Run Git installer silently
  ansible.windows.win_command:
    cmd: C:\Windows\Temp\GitSetup.exe /SILENT
  when: git_check.rc != 0

- name: Clone git repo to Windows Temp
  ansible.windows.win_shell: |
    git clone https://github.com/davidprowe/BadBlood C:\Windows\Temp\BadBlood
  args:
    chdir: C:\Windows\Temp

- name: Check if BadBlood directory exists
  ansible.windows.win_stat:
    path: C:\Windows\Temp\BadBlood
  register: badblood_check

- name: Run BadBlood script if directory exists. This takes a while...
  ansible.windows.win_powershell:
    script: C:\Windows\Temp\BadBlood\Invoke-BadBlood.ps1
  when: badblood_check.stat.exists
